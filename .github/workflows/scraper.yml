name: Scraper
on:
  push:
    branches:
      - 'scraper'
  schedule:
    - cron:  '0 8 * * MON'
  workflow_dispatch:
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@v1
      with:
        bundler-cache: true
    - name: Run scraper
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        bundle exec rake scraper
        git config --global user.email "micarrera-bot@cedarcode.com"
        git config --global user.name "micarrera-bot"
        sed -i -e 's/ $//' db/data/*.yml
        git add db/data
        if ! git diff --cached --quiet;
        then
            git commit -m 'Test scraper'
            git push -f origin HEAD:test-scraper
            gh pr view test-scraper && gh pr create --title "Test scraper" --body "Test scraper updates" --head test-scraper
        else
            echo "There were no changes. Nothing to do."
        fi
